#!/bin/sh

audio_input=$(pw-metadata | awk -F'"' '/default.audio.sink/{print $4}').monitor

filename=$(date +%F_%T.mkv)

echo Capturing audio from: $audio_input 
echo $filename

if [ -z $(pgrep wf-recorder) ]; then
	echo "$HOME/Videos/${filename}" > /tmp/tmp.streamablelink
	notify-send "Recording Started"
	if [ "$1" == "-s" ]; then
		wf-recorder -f $HOME/Videos/$filename --audio="$audio_input" -g "$(swaymsg -t get_tree | jq -r '.. | select(.pid? and .visible?) | .rect | "\(.x),\(.y) \(.width)x\(.height)"' | slurp -c "#FFFFFF" )" >/dev/null 2>&1 &
		sleep 2
		while [ ! -z $(pgrep -x slurp) ]; do wait; done
		pkill -RTMIN+8 waybar
	else
		wf-recorder -f $HOME/Videos/$filename --audio="$audio_input" -o $(swaymsg -t get_outputs | jq -r '.[] | select(.focused) | .name') >/dev/null 2>&1 &
		sleep 2
		while [ ! -z $(pgrep -x slurp) ]; do wait; done
		pkill -RTMIN+8 waybar 
	fi
else
	killall -s SIGINT wf-recorder
	notify-send "Recording Complete"
	while [ ! -z $(pgrep -x wf-recorder) ]; do wait; done
	pkill -RTMIN+8 waybar
	streamableUpload $(cat /tmp/tmp.streamablelink)
fi
